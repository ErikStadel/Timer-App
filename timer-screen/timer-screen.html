<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#01161E" />
    <title>Timer Running</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Karla:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              dark: '#01161E',
              background: '#124559',
              primary: '#598392',
              secondary: '#AEC3B0',
              light: '#EFF6E0',
              accent: '#83c5be',
              rest: '#94d1be',
              interval: '#e76f51',
              warning: '#fc814a',
            },
            fontFamily: {
              karla: ['Karla', 'sans-serif'],
            },
          },
        },
      };
    </script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        padding-top: env(safe-area-inset-top);
        background-color: #01161E;
        font-family: 'Karla', sans-serif;
        display: flex;
        flex-direction: column;
        overscroll-behavior: none;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 50;
        padding: 1rem;
        background-color: #01161E;
        transition: background-color 0.3s ease, backdrop-filter 0.3s ease;
      }

      header::before {
        content: "";
        position: absolute;
        top: -100vh;
        left: 0;
        right: 0;
        height: 100vh;
        background-color: #01161E;
        z-index: -1;
      }

      header.scrolled {
        background-color: rgba(1, 22, 30, 0.7);
        backdrop-filter: blur(6px);
      }

      .main-timer {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }

      .current-interval-display {
        background-color: #124559; /* Hintergrundfarbe für aktuelle Intervall-Info */
        border-radius: 1.5rem; /* Abgerundete Ecken */
        padding: 1.5rem 2rem;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); /* Dezenter Schatten */
        min-width: 280px; /* Mindestbreite für das Feld */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem; /* Abstand zwischen Name und Typ */
        margin-bottom: 2rem;
      }

      .current-interval-display.type-interval {
        border: 2px solid #e76f51; /* Farbe für Interval */
        color: #e76f51;
      }

      .current-interval-display.type-rest {
        border: 2px solid #94d1be; /* Farbe für Rest */
        color: #94d1be;
      }

      .timer-display {
        font-size: 6rem; /* Große Schrift für die Uhrzeit */
        font-weight: bold;
        color: #EFF6E0; /* Helle Farbe für die Uhrzeit */
        letter-spacing: -0.05em; /* Etwas engerer Buchstabenabstand */
      }

      .interval-name {
        font-size: 1.75rem; /* Größerer Name */
        font-weight: bold;
        color: #EFF6E0;
        margin-bottom: 0.5rem;
      }

      .interval-type {
        font-size: 1.2rem;
        color: #EFF6E0;
        opacity: 0.8;
      }

      .next-interval-info {
        color: #83c5be;
        font-size: 1.1rem;
        margin-top: 1rem;
      }

      .button-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem; /* Größerer Abstand zwischen den Buttons */
        margin-top: 2rem;
        width: 100%;
        max-width: 450px; /* Begrenzung der Breite der Buttons */
      }

      .control-button {
        background-color: #598392; /* primary Farbe für Buttons */
        color: #EFF6E0;
        border-radius: 9999px; /* Vollständig rund */
        width: 80px; /* Feste Größe */
        height: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.25rem;
        font-weight: bold;
        transition: transform 0.1s ease, background-color 0.2s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0); /* Entfernt den Tap-Highlight auf iOS */
      }

      .control-button:active {
        transform: scale(0.95);
        background-color: #4A7180;
      }

      .control-button#playPauseButton {
        background-color: #83c5be; /* accent Farbe für Play/Pause */
        color: #01161E;
        grid-column: 2; /* Zentriert den Play/Pause Button */
        font-size: 2rem; /* Größerer Play/Pause Icon */
      }

      .control-button#playPauseButton.paused {
        background-color: #e76f51; /* interval Farbe, wenn pausiert */
      }

      .control-button#playPauseButton.stopped {
        background-color: #83c5be; /* accent Farbe, wenn gestoppt */
      }

      .control-button#resetButton {
        color: #EFF6E0;
        background-color: #fc814a; /* warning Farbe für Reset */
      }
    </style>
  </head>

  <body class="bg-dark text-light">
    <header id="header" class="text-light shadow-md">
      <div class="w-full flex justify-between items-center">
        <button id="backButton" class="text-accent font-semibold hover:underline">Back</button>
        <h1 id="timerName" class="text-xl font-bold text-accent tracking-wide"></h1>
        <button id="finishButton" class="text-accent font-semibold hover:underline">Finish</button>
      </div>
    </header>

    <main class="main-timer">
      <div id="currentIntervalDisplay" class="current-interval-display">
        <div id="intervalName" class="interval-name"></div>
        <div id="intervalType" class="interval-type"></div>
      </div>

      <div id="timerDisplay" class="timer-display">00:00</div>

      <div id="nextIntervalInfo" class="next-interval-info"></div>

      <div class="button-grid">
        <button id="previousButton" class="control-button">Prev</button>
        <button id="playPauseButton" class="control-button stopped">▶</button>
        <button id="nextButton" class="control-button">Next</button>
        <button id="resetButton" class="control-button" style="grid-column: 1 / 4;">Reset</button>
      </div>
    </main>

    <script>
      const header = document.getElementById('header');
      const backButton = document.getElementById('backButton');
      const finishButton = document.getElementById('finishButton');
      const timerNameDisplay = document.getElementById('timerName');
      const currentIntervalDisplay = document.getElementById('currentIntervalDisplay');
      const intervalNameDisplay = document.getElementById('intervalName');
      const intervalTypeDisplay = document.getElementById('intervalType');
      const timerDisplay = document.getElementById('timerDisplay');
      const nextIntervalInfoDisplay = document.getElementById('nextIntervalInfo');
      const previousButton = document.getElementById('previousButton');
      const playPauseButton = document.getElementById('playPauseButton');
      const nextButton = document.getElementById('nextButton');
      const resetButton = document.getElementById('resetButton');

      let currentTimer = null; // Der geladene Timer
      let currentIntervalIndex = 0;
      let currentRepeat = 0;
      let timeLeftInInterval = 0; // Sekunden
      let timerIntervalId = null; // Für setInterval
      let isPaused = true;

      // --- Hilfsfunktionen für Zeitformatierung ---

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      }

      function parseDurationToSeconds(durationString) {
        const parts = durationString.split(':');
        const minutes = parseInt(parts[0], 10);
        const seconds = parseInt(parts[1], 10);
        return minutes * 60 + seconds;
      }

      function getIntervalTypeName(type) {
        return type === 'interval' ? 'Interval' : 'Rest';
      }

      // --- Timer-Steuerungslogik ---

      function initializeTimer() {
        if (!currentTimer || currentTimer.intervals.length === 0) {
          timerNameDisplay.textContent = "No Timer Data";
          timerDisplay.textContent = "00:00";
          intervalNameDisplay.textContent = "";
          intervalTypeDisplay.textContent = "";
          currentIntervalDisplay.className = 'current-interval-display'; // Reset classes
          nextIntervalInfoDisplay.textContent = "";
          playPauseButton.disabled = true;
          previousButton.disabled = true;
          nextButton.disabled = true;
          resetButton.disabled = true;
          return;
        }

        currentIntervalIndex = 0;
        currentRepeat = 0;
        isPaused = true;
        playPauseButton.textContent = '▶';
        playPauseButton.classList.remove('paused');
        playPauseButton.classList.add('stopped');
        resetButton.style.display = 'block'; // Reset-Button immer sichtbar

        timerNameDisplay.textContent = currentTimer.name;
        loadCurrentInterval();
        updateNextIntervalInfo();
      }

      function loadCurrentInterval() {
        const interval = currentTimer.intervals[currentIntervalIndex];
        if (!interval) {
          // Timer beendet
          handleTimerEnd();
          return;
        }

        intervalNameDisplay.textContent = interval.name;
        intervalTypeDisplay.textContent = getIntervalTypeName(interval.type);
        currentIntervalDisplay.className = `current-interval-display type-${interval.type}`;

        timeLeftInInterval = parseDurationToSeconds(interval.duration);
        timerDisplay.textContent = formatTime(timeLeftInInterval);
      }

      function updateTimerDisplay() {
        timerDisplay.textContent = formatTime(timeLeftInInterval);
      }

      function startTimer() {
        if (!currentTimer || currentTimer.intervals.length === 0) return;
        if (!isPaused) return; // Already running

        isPaused = false;
        playPauseButton.textContent = '⏸';
        playPauseButton.classList.remove('stopped');
        playPauseButton.classList.add('paused');

        timerIntervalId = setInterval(() => {
          timeLeftInInterval--;
          updateTimerDisplay();

          if (timeLeftInInterval <= 0) {
            clearInterval(timerIntervalId);
            playSignal(currentIntervalIndex); // Signal spielen

            // Wechsel zum nächsten Intervall oder zur nächsten Wiederholung
            currentIntervalIndex++;
            if (currentIntervalIndex < currentTimer.intervals.length) {
              // Nächstes Intervall in der aktuellen Wiederholung
              loadCurrentInterval();
              startTimer(); // Startet das nächste Intervall sofort
            } else {
              // Aktuelle Wiederholung beendet
              currentRepeat++;
              if (currentRepeat < currentTimer.repeat) {
                // Nächste Wiederholung
                currentIntervalIndex = 0; // Zurück zum ersten Intervall
                loadCurrentInterval();
                startTimer(); // Startet die nächste Wiederholung sofort
              } else {
                // Alle Wiederholungen und Intervalle beendet
                handleTimerEnd();
              }
            }
          }
          updateNextIntervalInfo(); // Info wird kontinuierlich aktualisiert
        }, 1000);
      }

      function pauseTimer() {
        if (isPaused) return;
        isPaused = true;
        clearInterval(timerIntervalId);
        playPauseButton.textContent = '▶';
        playPauseButton.classList.remove('paused');
        playPauseButton.classList.add('stopped');
      }

      function resetTimer() {
        pauseTimer(); // Erst pausieren
        initializeTimer(); // Zurücksetzen auf Anfangszustand
        console.log("Timer reset.");
      }

      function nextInterval() {
          pauseTimer(); // Erst pausieren, falls aktiv
          currentIntervalIndex++;
          if (currentIntervalIndex >= currentTimer.intervals.length) {
              currentRepeat++;
              if (currentRepeat >= currentTimer.repeat) {
                  // Wenn alle Wiederholungen durch sind, beende den Timer
                  handleTimerEnd();
                  return;
              }
              currentIntervalIndex = 0; // Springe zur nächsten Wiederholung
          }
          loadCurrentInterval();
          updateNextIntervalInfo();
          startTimer(); // Starte das neue Intervall direkt
      }

      function previousInterval() {
          pauseTimer(); // Erst pausieren, falls aktiv
          currentIntervalIndex--;
          if (currentIntervalIndex < 0) {
              // Wenn am Anfang der aktuellen Wiederholung, springe zur vorherigen Wiederholung
              currentRepeat--;
              if (currentRepeat < 0) {
                  // Wenn am Anfang des gesamten Timers, bleibe hier und reset
                  currentRepeat = 0;
                  currentIntervalIndex = 0;
                  initializeTimer();
                  return;
              }
              currentIntervalIndex = currentTimer.intervals.length - 1; // Springe zum letzten Intervall der vorherigen Wiederholung
          }
          loadCurrentInterval();
          updateNextIntervalInfo();
          startTimer(); // Starte das neue Intervall direkt
      }


      function handleTimerEnd() {
        clearInterval(timerIntervalId);
        timerDisplay.textContent = "00:00";
        intervalNameDisplay.textContent = "Finished!";
        intervalTypeDisplay.textContent = "";
        currentIntervalDisplay.className = 'current-interval-display'; // Reset class
        currentIntervalDisplay.style.borderColor = '#83c5be'; // Akzentfarbe für "Finished"
        currentIntervalDisplay.style.color = '#EFF6E0'; // Textfarbe für "Finished"
        nextIntervalInfoDisplay.textContent = "Timer completed!";
        isPaused = true;
        playPauseButton.textContent = '▶'; // Kann den Timer neu starten
        playPauseButton.classList.remove('paused');
        playPauseButton.classList.add('stopped');
        playSignal('finish'); // Signal für Timer-Ende
      }

      function updateNextIntervalInfo() {
          let infoText = "";
          let nextInterval = null;

          if (currentRepeat < currentTimer.repeat) {
              // Es gibt noch Wiederholungen
              let nextIdx = currentIntervalIndex + 1;
              let nextRep = currentRepeat;

              if (nextIdx >= currentTimer.intervals.length) {
                  // Nächste Wiederholung, erstes Intervall
                  nextIdx = 0;
                  nextRep++;
              }

              if (nextRep < currentTimer.repeat) {
                  nextInterval = currentTimer.intervals[nextIdx];
                  if (nextInterval) {
                      infoText = `Nächstes: ${nextInterval.name} (${getIntervalTypeName(nextInterval.type)}) - ${formatTime(parseDurationToSeconds(nextInterval.duration))}`;
                      infoText += ` | Runde ${currentRepeat + 1}/${currentTimer.repeat}`; // Aktuelle Runde
                  }
              } else {
                  infoText = `Letzte Runde: ${currentRepeat + 1}/${currentTimer.repeat}`;
                  if (currentIntervalIndex === currentTimer.intervals.length - 1) {
                      infoText = "Letztes Intervall dieser Runde.";
                  } else {
                      nextInterval = currentTimer.intervals[currentIntervalIndex + 1];
                      infoText = `Nächstes: ${nextInterval.name} (${getIntervalTypeName(nextInterval.type)}) | Letzte Runde`;
                  }
              }
          } else {
              infoText = "Timer beendet.";
          }
          nextIntervalInfoDisplay.textContent = infoText;
      }


      // --- Sound / Signal Logik (Platzhalter) ---
      function playSignal(signalType) {
        // Hier müsste die Logik für das Abspielen von Signalen implementiert werden.
        // Die Signale müssten aus den Sound-Einstellungen geladen werden.
        // Für den Anfang können wir einfach einen Konsolen-Log machen.
        console.log(`Playing signal for: ${signalType}`);
        // Beispiel: Neue Audio-Objekte erstellen und abspielen
        // const audio = new Audio('path/to/your/signal.mp3');
        // audio.play();
      }

      // --- Event Listener ---

      backButton.addEventListener('click', () => {
        pauseTimer(); // Timer pausieren, bevor zurück navigiert wird
        window.location.href = '../home-screen/timer-review/review.html'; // Zurück zur Review-Seite
      });

      finishButton.addEventListener('click', () => {
        if (confirm("Möchtest du den Timer wirklich beenden?")) {
            resetTimer(); // Setzt den Timer zurück
            window.location.href = '../home-screen/index.html'; // Zurück zum Home-Screen
        }
      });

      playPauseButton.addEventListener('click', () => {
        if (isPaused) {
          startTimer();
        } else {
          pauseTimer();
        }
      });

      nextButton.addEventListener('click', nextInterval);
      previousButton.addEventListener('click', previousInterval);
      resetButton.addEventListener('click', resetTimer);

      window.addEventListener('scroll', () => {
        if (window.scrollY > 0) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
      });

      // --- Initialisierung beim Laden der Seite ---
      document.addEventListener('DOMContentLoaded', () => {
        const storedTimer = localStorage.getItem('currentRunningTimer');
        if (storedTimer) {
          currentTimer = JSON.parse(storedTimer);
          // Setze den Namen des Timers im Header
          timerNameDisplay.textContent = currentTimer.name;
          initializeTimer();
          // Lösche den Eintrag, nachdem er gelesen wurde, da er nur für diese Ausführung gedacht ist
          localStorage.removeItem('currentRunningTimer');
        } else {
          console.error('Kein Timer im localStorage für Ausführung gefunden. Zurück zum Home-Screen.');
          // Wenn kein Timer gefunden wird, zurück zum Home-Screen navigieren
          window.location.href = '../home-screen/index.html';
        }
      });
    </script>
  </body>
</html>