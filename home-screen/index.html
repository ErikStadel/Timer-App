<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#01161E" />
    <title>Home Screen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="../js/dataStorage.js"></script> <!-- dataStorage.js wird eingebunden -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              dark: '#01161E',
              background: '#124559',
              primary: '#598392',
              secondary: '#AEC3B0',
              light: '#EFF6E0',
              accent: '#83c5be',
              rest: '#94d1be',
              interval: '#e76f51',
              warning: '#fc814a',
            },
            fontFamily: {
              karla: ['Karla', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <style>
      /* Alle Original-Styles unverändert belassen */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        padding-top: env(safe-area-inset-top);
        background-color: #01161E;
        font-family: 'Karla', sans-serif;
        overscroll-behavior: none;
        scroll-padding-top: 4rem;
        scroll-behavior: smooth;
        color: #EFF6E0;
      }

      /* ... Andere Styles aus deinem Original-Code */
    </style>
  </head>
  <body class="text-light">
    <header id="header" class="text-light shadow-md">
      <div class="w-full flex justify-between items-center">
        <button id="optionsButton" class="header-button">Options</button>
        <h1 class="text-xl font-bold text-accent tracking-wide">Timer</h1>
        <button id="saveButton" class="header-button" style="display: none;">Save Order</button>
        <button id="addButton" class="header-button text-2xl leading-none hover:scale-110 transition-transform duration-150">+</button>
      </div>
    </header>
    <ul class="timer-list"></ul>

    <div class="confirmation-dialog-overlay" id="deleteConfirmationDialog">
      <div class="confirmation-dialog">
        <p>Delete Timer?</p>
        <div class="confirmation-dialog-buttons">
          <button class="btn-cancel" id="cancelDelete">Cancel</button>
          <button class="btn-confirm" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>

    <script>
      const header = document.getElementById('header');
      const timerList = document.querySelector('.timer-list');
      const addButton = document.getElementById('addButton');
      const saveButton = document.getElementById('saveButton');
      const optionsButton = document.getElementById('optionsButton');
      const deleteConfirmationDialog = document.getElementById('deleteConfirmationDialog');
      const cancelDeleteButton = document.getElementById('cancelDelete');
      const confirmDeleteButton = document.getElementById('confirmDelete');

      let activeOptionsItem = null;
      let sortable = null;
      let longPressTimer = null;
      let longPressThreshold = 1000;
      let isSortableMode = false;
      let isSwipingOrScrolling = false;
      let touchStartX = 0;
      let touchStartY = 0;
      let movementThreshold = 10;

      let timers = [];
      let signals = [];

      // --- Integration der Datenlogik ---
      function loadData() {
        timers = loadTimers(); // Timer aus dataStorage.js laden
        signals = loadSignals(); // Signale aus dataStorage.js laden
      }

      function saveData(timers) {
        saveTimers(timers); // Timer speichern
      }

      function calculateTotalTimerDuration(timer) {
        let duration = 0;
        if (timer.intervals && Array.isArray(timer.intervals)) {
          timer.intervals.forEach((interval) => {
            duration += interval.duration;
          });
        }
        return duration * (timer.repeat || 1);
      }

      function formatDuration(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      function renderTimerList() {
        timerList.innerHTML = '';
        if (timers.length === 0) {
          const noTimersMessage = document.createElement('li');
          noTimersMessage.classList.add('text-center', 'text-secondary', 'mt-8', 'text-lg', 'p-4');
          noTimersMessage.textContent = 'No timers yet. Tap "+" to create one!';
          timerList.appendChild(noTimersMessage);
          return;
        }

        timers.forEach((timer) => {
          const li = document.createElement('li');
          li.classList.add('timer-item');
          li.setAttribute('data-timer-id', timer.id);

          const nameSpan = document.createElement('span');
          nameSpan.classList.add('timer-name');
          nameSpan.textContent = timer.name;

          const durationSpan = document.createElement('span');
          durationSpan.classList.add('timer-duration');
          durationSpan.textContent = formatDuration(calculateTotalTimerDuration(timer));

          li.appendChild(nameSpan);
          li.appendChild(durationSpan);

          timerList.appendChild(li);
        });
      }

      // --- Bestehende Event-Logik (NICHT VERÄNDERT) ---
      addButton.addEventListener('click', () => {
        localStorage.removeItem('selectedTimerId');
        window.location.href = '../timer-editor/timer-editor.html';
      });

      saveButton.addEventListener('click', () => {
        isSortableMode = false;
        renderTimerList();
      });

      confirmDeleteButton.addEventListener('click', () => {
        timers = timers.filter((timer) => timer.id !== timerToDeleteId);
        saveData(timers);
        renderTimerList();
      });

      // Initialisierung
      document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderTimerList();
      });
    </script>
  </body>
</html>