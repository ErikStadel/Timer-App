<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Timer</title>
  <script src="../js/dataStorage.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #333;
      color: white;
    }
    header a.back {
      color: white;
      text-decoration: none;
      font-size: 16px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header button.save {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    header button.save:hover {
      background-color: #45a049;
    }
    main {
      padding: 20px;
    }
    section {
      margin-bottom: 20px;
    }
    section h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    ul#interval-list {
      list-style: none;
      padding: 0;
    }
    ul#interval-list li {
      padding: 10px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    ul#interval-list li a {
      text-decoration: none;
      color: #333;
      display: block;
    }
    a.add-interval {
      display: inline-block;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 10px;
    }
    a.add-interval:hover {
      background-color: #0056b3;
    }
    dialog {
      border: none;
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    dialog button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    dialog button.cancel {
      background-color: #ccc;
    }
    dialog button.delete {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <a href="../home-screen/index.html" class="back">Back</a>
    <h1>Add Timer</h1>
    <button class="save">Save</button>
  </header>

  <main>
    <section>
      <label for="timer-name">Timer Name</label>
      <input type="text" id="timer-name" placeholder="Timer Name">
    </section>

    <section>
      <label for="repeat">Repeat</label>
      <input type="number" id="repeat" min="1" value="1">
    </section>

    <section>
      <h2>Intervals</h2>
      <ul id="interval-list"></ul>
      <a href="#" class="add-interval">+ Add Interval</a>
    </section>
  </main>

  <dialog id="delete-interval-dialog">
    <p>Delete Interval?</p>
    <button class="cancel">Cancel</button>
    <button class="delete">Delete</button>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // URL-Parameter auslesen
      const urlParams = new URLSearchParams(window.location.search);
      const timerId = urlParams.get('timerId');

      // Timer laden oder neuen Timer vorbereiten
      let timers = loadTimers();
      let timer = timerId ? timers.find(t => t.id === timerId) : null;
      if (!timer && timerId) {
        console.error('Timer nicht gefunden:', timerId);
        return;
      }

      // Eingabefelder füllen
      const timerNameInput = document.getElementById('timer-name');
      const repeatInput = document.getElementById('repeat');
      if (timer) {
        timerNameInput.value = timer.name || '';
        repeatInput.value = timer.repeat || 1;
      }

      // Add Interval Link aktualisieren
      const addIntervalLink = document.querySelector('.add-interval');
      if (addIntervalLink && timerId) {
        addIntervalLink.href = `../interval-editor/interval-editor.html?timerId=${timerId}`;
      }

      // Intervalle anzeigen
      const intervalList = document.getElementById('interval-list');
      if (timer && intervalList) {
        intervalList.innerHTML = ''; // Liste leeren
        timer.intervals.forEach(interval => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="../interval-editor/interval-editor.html?timerId=${timerId}&intervalId=${interval.id}">${interval.name} (${interval.duration}s, ${interval.type})</a>`;
          intervalList.appendChild(li);
        });
      }

      // Save-Button Logik
      document.querySelector('.save').addEventListener('click', () => {
        const name = timerNameInput.value || 'Unnamed Timer';
        const repeat = parseInt(repeatInput.value) || 1;

        if (timer) {
          // Timer aktualisieren
          timer.name = name;
          timer.repeat = repeat;
        } else {
          // Neuer Timer
          timer = {
            id: `timer-${Date.now()}`,
            name,
            repeat,
            intervals: []
          };
          timers.push(timer);
        }

        // Timer speichern
        saveTimers(timers);

        // Zurück zur Startseite
        window.location.href = '../home-screen/index.html';
      });

      // Delete Interval Dialog (falls benötigt)
      const deleteDialog = document.getElementById('delete-interval-dialog');
      const cancelButton = deleteDialog.querySelector('.cancel');
      const deleteButton = deleteDialog.querySelector('.delete');
      let intervalToDelete = null;

      // Beispiel: Löschen eines Intervalls (optional, falls später benötigt)
      intervalList.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-interval')) {
          intervalToDelete = e.target.dataset.intervalId;
          deleteDialog.showModal();
        }
      });

      cancelButton.addEventListener('click', () => {
        deleteDialog.close();
        intervalToDelete = null;
      });

      deleteButton.addEventListener('click', () => {
        if (intervalToDelete && timer) {
          timer.intervals = timer.intervals.filter(i => i.id !== intervalToDelete);
          saveTimers(timers);
          deleteDialog.close();
          // Interval-Liste aktualisieren
          intervalList.innerHTML = '';
          timer.intervals.forEach(interval => {
            const li = document.createElement('li');
            li.innerHTML = `<a href="../interval-editor/interval-editor.html?timerId=${timerId}&intervalId=${interval.id}">${interval.name} (${interval.duration}s, ${interval.type})</a>`;
            intervalList.appendChild(li);
          });
        }
      });
    });
  </script>
</body>
</html>