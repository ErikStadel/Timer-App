<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Intervall Editor</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/dataStorage.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#01161E',
            background: '#124559',
            primary: '#598392',
            secondary: '#AEC3B0',
            light: '#EFF6E0',
            accent: '#83c5be',
            rest: '#94d1be',
            interval: '#e76f51',
            warning: '#fc814a',
          },
          fontFamily: {
            karla: ['Karla', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <link
    href="https://fonts.googleapis.com/css2?family=Karla:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    .tab-btn {
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      flex: 1;
      text-align: center;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .tab-btn.active {
      background-color: #83c5be;
      color: #124559;
      font-weight: 700;
      transform: scale(1.1);
    }

    .tab-btn.inactive {
      background-color: #01161E;
      border: 2px solid #83c5be;
      color: #83c5be;
      font-weight: 600;
    }

    .tab-btn.inactive:hover {
      background-color: rgba(131, 197, 190, 0.15);
    }

    .wheel-container {
      position: relative;
      width: 100%;
      z-index: 30;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .wheel {
      height: 120px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: y mandatory;
      scroll-padding: 40px 0;
      scrollbar-width: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 0;
      overscroll-behavior-x: none;
      touch-action: pan-y;
      width: 100%;
    }

    .wheel::-webkit-scrollbar {
      display: none;
    }

    .wheel-item {
      scroll-snap-align: center;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.25rem;
      user-select: none;
      transition: opacity 0.2s ease, transform 0.2s ease, color 0.2s;
      color: #83c5be;
      -webkit-touch-callout: none;
      opacity: 0.6;
      transform: scale(0.9);
      min-width: 60px;
      padding: 0 20px;
      white-space: nowrap;
    }

    .wheel-item.selected {
      color: #EFF6E0;
      opacity: 1;
      transform: scale(1.1);
      font-size: 1.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    body {
      overflow: hidden;
    }

    .overlay {
      z-index: 10;
    }

    .popup {
      z-index: 20;
    }
  </style>
</head>

<body class="bg-dark text-light font-karla p-4 flex items-center justify-center min-h-screen">
  <header id="header" class="text-light shadow-md w-full fixed top-0 left-0">
    <div class="w-full flex justify-between items-center p-4 bg-dark">
      <button class="text-accent font-semibold hover:underline back">Back</button>
      <h1 class="text-xl font-bold text-accent tracking-wide">Interval Editor</h1>
      <button id="saveIntervalButton" class="text-accent font-semibold hover:underline">Save</button>
    </div>
  </header>

  <div class="relative bg-background rounded-3xl p-8 w-full max-w-md shadow-2xl shadow-black/40 mt-16">
    <div class="flex justify-center items-center mb-6">
      <input
        type="text"
        id="intervalNameInput"
        class="bg-transparent text-2xl font-bold text-accent border-b border-accent focus:outline-none text-center w-full"
        placeholder="Intervall"
        onclick="this.select()"
      />
    </div>

    <div class="flex justify-center space-x-4 mb-6">
      <button id="tab-interval" class="tab-btn active px-5 py-2 rounded-full">
        Interval
      </button>
      <button id="tab-rest" class="tab-btn inactive px-5 py-2 rounded-full">
        Rest
      </button>
    </div>

    <div id="content-interval" class="tab-content active">
      <div class="flex justify-between space-x-4 mb-8">
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Min</span>
          <div class="wheel-container">
            <div class="wheel" id="minutes-wheel">
              <div class="wheel-item">00</div>
              <div class="wheel-item">01</div>
              <div class="wheel-item">02</div>
              <div class="wheel-item">03</div>
              <div class="wheel-item">04</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">06</div>
              <div class="wheel-item">07</div>
              <div class="wheel-item">08</div>
              <div class="wheel-item">09</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">11</div>
              <div class="wheel-item">12</div>
              <div class="wheel-item">13</div>
              <div class="wheel-item">14</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">16</div>
              <div class="wheel-item">17</div>
              <div class="wheel-item">18</div>
              <div class="wheel-item">19</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">21</div>
              <div class="wheel-item">22</div>
              <div class="wheel-item">23</div>
              <div class="wheel-item">24</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">26</div>
              <div class="wheel-item">27</div>
              <div class="wheel-item">28</div>
              <div class="wheel-item">29</div>
              <div class="wheel-item">30</div>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Sek</span>
          <div class="wheel-container">
            <div class="wheel" id="seconds-wheel">
              <div class="wheel-item">00</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">30</div>
              <div class="wheel-item">35</div>
              <div class="wheel-item">40</div>
              <div class="wheel-item">45</div>
              <div class="wheel-item">50</div>
              <div class="wheel-item">55</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="content-rest" class="tab-content">
      <div class="flex justify-between space-x-4 mb-8">
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Min</span>
          <div class="wheel-container">
            <div class="wheel" id="minutes-wheel-rest">
              <div class="wheel-item">00</div>
              <div class="wheel-item">01</div>
              <div class="wheel-item">02</div>
              <div class="wheel-item">03</div>
              <div class="wheel-item">04</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">06</div>
              <div class="wheel-item">07</div>
              <div class="wheel-item">08</div>
              <div class="wheel-item">09</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">11</div>
              <div class="wheel-item">12</div>
              <div class="wheel-item">13</div>
              <div class="wheel-item">14</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">16</div>
              <div class="wheel-item">17</div>
              <div class="wheel-item">18</div>
              <div class="wheel-item">19</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">21</div>
              <div class="wheel-item">22</div>
              <div class="wheel-item">23</div>
              <div class="wheel-item">24</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">26</div>
              <div class="wheel-item">27</div>
              <div class="wheel-item">28</div>
              <div class="wheel-item">29</div>
              <div class="wheel-item">30</div>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Sek</span>
          <div class="wheel-container">
            <div class="wheel" id="seconds-wheel-rest">
              <div class="wheel-item">00</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">30</div>
              <div class="wheel-item">35</div>
              <div class="wheel-item">40</div>
              <div class="wheel-item">45</div>
              <div class="wheel-item">50</div>
              <div class="wheel-item">55</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const wheels = document.querySelectorAll('.wheel');
    const intervalNameInput = document.getElementById('intervalNameInput');
    const tabInterval = document.getElementById('tab-interval');
    const tabRest = document.getElementById('tab-rest');
    const contentInterval = document.getElementById('content-interval');
    const contentRest = document.getElementById('content-rest');
    const saveIntervalButton = document.getElementById('saveIntervalButton');

    // --- Wheel-Funktionalität ---
    wheels.forEach((wheel) => {
        setTimeout(() => updateWheel(wheel), 10);
        wheel.addEventListener('scroll', () => updateWheel(wheel));
    });

    function updateWheel(wheel) {
        const items = wheel.getElementsByClassName('wheel-item');
        clearTimeout(wheel.scrollTimeout);

        wheel.scrollTimeout = setTimeout(() => {
            const wheelCenter = wheel.offsetHeight / 2 + wheel.getBoundingClientRect().top;
            let closestItem = null;
            let minDistance = Infinity;

            Array.from(items).forEach((item) => {
                const rect = item.getBoundingClientRect();
                const distance = Math.abs(rect.top + rect.height / 2 - wheelCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestItem = item;
                }
                item.classList.remove('selected');
            });

            if (closestItem) {
                closestItem.classList.add('selected');
                const currentScrollTop = wheel.scrollTop;
                const targetScrollTop = closestItem.offsetTop - wheel.offsetHeight / 2 + closestItem.offsetHeight / 2;
                if (Math.abs(currentScrollTop - targetScrollTop) > 1) {
                     wheel.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                }
            }
        }, 50);
    }

    function setWheelValue(wheelId, value) {
        const wheel = document.getElementById(wheelId);
        if (wheel) {
            const items = Array.from(wheel.querySelectorAll('.wheel-item'));
            const itemToSelect = items.find(item => item.textContent === value);
            if (itemToSelect) {
                wheel.scrollTop = itemToSelect.offsetTop - wheel.offsetHeight / 2 + itemToSelect.offsetHeight / 2;
                setTimeout(() => updateWheel(wheel), 100);
            }
        }
    }

    // --- Tab-Funktionalität ---
    tabInterval.addEventListener('click', function() {
      tabInterval.classList.add('active');
      tabInterval.classList.remove('inactive');
      tabRest.classList.add('inactive');
      tabRest.classList.remove('active');

      contentInterval.classList.add('active');
      contentRest.classList.remove('active');

      setTimeout(() => {
          document.querySelectorAll('#content-interval .wheel').forEach(updateWheel);
      }, 0);
    });

    tabRest.addEventListener('click', function() {
      tabRest.classList.add('active');
      tabRest.classList.remove('inactive');
      tabInterval.classList.add('inactive');
      tabInterval.classList.remove('active');

      contentRest.classList.add('active');
      contentInterval.classList.remove('active');

      setTimeout(() => {
          document.querySelectorAll('#content-rest .wheel').forEach(updateWheel);
      }, 0);
    });

    // --- Initialisierung und Datenlogik ---
    document.addEventListener('DOMContentLoaded', () => {
        // URL-Parameter auslesen
        const urlParams = new URLSearchParams(window.location.search);
        const timerId = urlParams.get('timerId');
        const intervalId = urlParams.get('intervalId');

        if (!timerId) {
            console.error('Keine timerId in der URL gefunden');
            alert('Timer-ID fehlt. Bitte erneut versuchen.');
            return;
        }

        // Back-Link aktualisieren
        const backButton = document.querySelector('.back');
        if (backButton) {
            backButton.onclick = () => window.location.href = `../timer-editor/timer-editor.html?timerId=${timerId}`;
        }

        // Timer laden
        const timers = loadTimers();
        const timer = timers.find(t => t.id === timerId);
        let interval = null;
        if (intervalId && timer) {
            interval = timer.intervals.find(i => i.id === intervalId);
        }

        // Eing’s
        if (interval) {
            intervalNameInput.value = interval.name || 'Intervall';
            const durationSeconds = interval.duration;
            const minutes = Math.floor(durationSeconds / 60).toString().padStart(2, '0');
            const seconds = (durationSeconds % 60).toString().padStart(2, '0');

            if (interval.type === 'rest') {
                tabRest.click();
                setWheelValue('minutes-wheel-rest', minutes);
                setWheelValue('seconds-wheel-rest', seconds);
            } else {
                tabInterval.click();
                setWheelValue('minutes-wheel', minutes);
                setWheelValue('seconds-wheel', seconds);
            }
        } else {
            // Standardwerte für neues Intervall
            setWheelValue('minutes-wheel', '00');
            setWheelValue('seconds-wheel', '00');
            intervalNameInput.value = 'Intervall';
            tabInterval.click();
        }

        // Save-Button Logik
        saveIntervalButton.addEventListener('click', () => {
            if (!timer) {
                console.error('Timer nicht gefunden:', timerId);
                alert('Timer nicht gefunden. Bitte erneut versuchen.');
                return;
            }

            const name = intervalNameInput.value.trim() || 'Intervall';
            const type = tabInterval.classList.contains('active') ? 'interval' : 'rest';

            let minutesElement, secondsElement;
            if (type === 'interval') {
                minutesElement = document.querySelector('#minutes-wheel .wheel-item.selected');
                secondsElement = document.querySelector('#seconds-wheel .wheel-item.selected');
            } else {
                minutesElement = document.querySelector('#minutes-wheel-rest .wheel-item.selected');
                secondsElement = document.querySelector('#seconds-wheel-rest .wheel-item.selected');
            }

            const minutes = parseInt(minutesElement ? minutesElement.textContent : '0');
            const seconds = parseInt(secondsElement ? secondsElement.textContent : '0');
            const duration = minutes * 60 + seconds;

            // Neues Intervall erstellen oder bestehendes aktualisieren
            if (interval) {
                interval.name = name;
                interval.duration = duration;
                interval.type = type;
            } else {
                const newInterval = {
                    id: generateUniqueId(),
                    name,
                    duration,
                    type,
                    signalId: 'signal-gong'
                };
                timer.intervals.push(newInterval);
            }

            // Timer speichern
            saveTimers(timers);

            // Zurück zu timer-editor.html
            window.location.href = `../timer-editor/timer-editor.html?timerId=${timerId}`;
        });

        // Initial alle Wheels aktualisieren
        wheels.forEach((wheel) => {
            updateWheel(wheel);
        });
    });
  </script>
</body>
</html>


