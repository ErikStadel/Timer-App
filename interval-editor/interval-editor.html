<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Intervall Popup</title>
  <script src="https://cdn.tailwindcss.com "></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#01161E',
            background: '#124559',
            primary: '#598392',
            secondary: '#AEC3B0',
            light: '#EFF6E0',
            accent: '#83c5be',
            rest: '#94d1be',
            interval: '#e76f51',
            warning: '#fc814a',
          },
          fontFamily: {
            karla: ['Karla', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Karla :wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Keine Änderung – Styles bleiben komplett unverändert */
  </style>
</head>
<body class="bg-dark text-light font-karla p-4 flex items-center justify-center min-h-screen">
  <div class="bg-black/60 backdrop-blur-md fixed inset-0 z-10 overlay"></div>
  <div class="relative z-20 bg-background rounded-3xl p-8 w-full max-w-md shadow-2xl shadow-black/40 popup">
    <div class="flex justify-center items-center mb-6">
      <input type="text" value="Intervall" id="intervalNameInput"
        class="bg-transparent text-2xl font-bold text-accent border-b border-accent focus:outline-none text-center w-full"
        onclick="this.select()" />
    </div>
    <div class="flex justify-center space-x-4 mb-6">
      <button id="tab-interval" class="tab-btn active px-5 py-2 rounded-full">Interval</button>
      <button id="tab-rest" class="tab-btn inactive px-5 py-2 rounded-full">Rest</button>
    </div>
    <div id="content-interval" class="tab-content active">
      <div class="flex justify-between space-x-4 mb-8">
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Min</span>
          <div class="wheel-container">
            <div class="wheel" id="minutes-wheel">
              <!-- Wheel Items -->
              <div class="wheel-item">00</div>
              <div class="wheel-item">01</div>
              <div class="wheel-item">02</div>
              <div class="wheel-item">03</div>
              <div class="wheel-item">04</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">06</div>
              <div class="wheel-item">07</div>
              <div class="wheel-item">08</div>
              <div class="wheel-item">09</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">11</div>
              <div class="wheel-item">12</div>
              <div class="wheel-item">13</div>
              <div class="wheel-item">14</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">16</div>
              <div class="wheel-item">17</div>
              <div class="wheel-item">18</div>
              <div class="wheel-item">19</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">21</div>
              <div class="wheel-item">22</div>
              <div class="wheel-item">23</div>
              <div class="wheel-item">24</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">26</div>
              <div class="wheel-item">27</div>
              <div class="wheel-item">28</div>
              <div class="wheel-item">29</div>
              <div class="wheel-item">30</div>
            </div>
          </div>
        </div>
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Sek</span>
          <div class="wheel-container">
            <div class="wheel" id="seconds-wheel">
              <div class="wheel-item">00</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">30</div>
              <div class="wheel-item">35</div>
              <div class="wheel-item">40</div>
              <div class="wheel-item">45</div>
              <div class="wheel-item">50</div>
              <div class="wheel-item">55</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="content-rest" class="tab-content">
      <div class="flex justify-between space-x-4 mb-8">
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Min</span>
          <div class="wheel-container">
            <div class="wheel" id="minutes-wheel-rest">
              <div class="wheel-item">00</div>
              <div class="wheel-item">01</div>
              <div class="wheel-item">02</div>
              <div class="wheel-item">03</div>
              <div class="wheel-item">04</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">06</div>
              <div class="wheel-item">07</div>
              <div class="wheel-item">08</div>
              <div class="wheel-item">09</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">11</div>
              <div class="wheel-item">12</div>
              <div class="wheel-item">13</div>
              <div class="wheel-item">14</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">16</div>
              <div class="wheel-item">17</div>
              <div class="wheel-item">18</div>
              <div class="wheel-item">19</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">21</div>
              <div class="wheel-item">22</div>
              <div class="wheel-item">23</div>
              <div class="wheel-item">24</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">26</div>
              <div class="wheel-item">27</div>
              <div class="wheel-item">28</div>
              <div class="wheel-item">29</div>
              <div class="wheel-item">30</div>
            </div>
          </div>
        </div>
        <div class="flex flex-col items-center flex-1">
          <span class="text-sm text-accent mb-1">Sek</span>
          <div class="wheel-container">
            <div class="wheel" id="seconds-wheel-rest">
              <div class="wheel-item">00</div>
              <div class="wheel-item">05</div>
              <div class="wheel-item">10</div>
              <div class="wheel-item">15</div>
              <div class="wheel-item">20</div>
              <div class="wheel-item">25</div>
              <div class="wheel-item">30</div>
              <div class="wheel-item">35</div>
              <div class="wheel-item">40</div>
              <div class="wheel-item">45</div>
              <div class="wheel-item">50</div>
              <div class="wheel-item">55</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button id="saveIntervalButton"
      class="w-full bg-accent text-dark py-3 rounded-xl font-bold hover:bg-accent/90 transition-all">
      Save
    </button>
  </div>

  <!-- Einbinden der zentralen Datenlogik -->
  <script src="../js/dataStorage.js"></script>

  <script>
    const wheels = document.querySelectorAll('.wheel');
    const intervalNameInput = document.getElementById('intervalNameInput');
    const tabInterval = document.getElementById('tab-interval');
    const tabRest = document.getElementById('tab-rest');
    const contentInterval = document.getElementById('content-interval');
    const contentRest = document.getElementById('content-rest');
    const saveIntervalButton = document.getElementById('saveIntervalButton');

    let currentIntervalId = null;

    // --- Wheel-Funktionalität ---
    wheels.forEach((wheel) => {
      setTimeout(() => updateWheel(wheel), 10);
      wheel.addEventListener('scroll', () => updateWheel(wheel));
    });

    function updateWheel(wheel) {
      const items = wheel.getElementsByClassName('wheel-item');
      clearTimeout(wheel.scrollTimeout);
      wheel.scrollTimeout = setTimeout(() => {
        const wheelCenter = wheel.offsetHeight / 2 + wheel.getBoundingClientRect().top;
        let closestItem = null;
        let minDistance = Infinity;
        Array.from(items).forEach((item) => {
          const rect = item.getBoundingClientRect();
          const distance = Math.abs(rect.top + rect.height / 2 - wheelCenter);
          if (distance < minDistance) {
            minDistance = distance;
            closestItem = item;
          }
          item.classList.remove('selected');
        });
        if (closestItem) {
          closestItem.classList.add('selected');
          const currentScrollTop = wheel.scrollTop;
          const targetScrollTop = closestItem.offsetTop - wheel.offsetHeight / 2 + closestItem.offsetHeight / 2;
          if (Math.abs(currentScrollTop - targetScrollTop) > 1) {
            wheel.scrollTo({
              top: targetScrollTop,
              behavior: 'smooth'
            });
          }
        }
      }, 50);
    }

    function setWheelValue(wheelId, value) {
      const wheel = document.getElementById(wheelId);
      if (wheel) {
        const items = Array.from(wheel.querySelectorAll('.wheel-item'));
        const itemToSelect = items.find(item => item.textContent === value);
        if (itemToSelect) {
          wheel.scrollTop = itemToSelect.offsetTop - wheel.offsetHeight / 2 + itemToSelect.offsetHeight / 2;
          setTimeout(() => updateWheel(wheel), 100);
        }
      }
    }

    // --- Tab-Funktionalität ---
    tabInterval.addEventListener('click', function () {
      tabInterval.classList.add('active');
      tabInterval.classList.remove('inactive');
      tabRest.classList.add('inactive');
      tabRest.classList.remove('active');
      contentInterval.classList.add('active');
      contentRest.classList.remove('active');
      setTimeout(() => {
        document.querySelectorAll('#content-interval .wheel').forEach(updateWheel);
      }, 0);
    });

    tabRest.addEventListener('click', function () {
      tabRest.classList.add('active');
      tabRest.classList.remove('inactive');
      tabInterval.classList.add('inactive');
      tabInterval.classList.remove('active');
      contentRest.classList.add('active');
      contentInterval.classList.remove('active');
      setTimeout(() => {
        document.querySelectorAll('#content-rest .wheel').forEach(updateWheel);
      }, 0);
    });

    // --- Speichern-Funktionalität ---
    saveIntervalButton.addEventListener('click', () => {
      const name = intervalNameInput.value.trim();
      const type = tabInterval.classList.contains('active') ? "interval" : "rest";
      let minutesElement;
      let secondsElement;

      if (type === "interval") {
        minutesElement = document.querySelector('#minutes-wheel .wheel-item.selected');
        secondsElement = document.querySelector('#seconds-wheel .wheel-item.selected');
      } else {
        minutesElement = document.querySelector('#minutes-wheel-rest .wheel-item.selected');
        secondsElement = document.querySelector('#seconds-wheel-rest .wheel-item.selected');
      }

      const minutes = minutesElement ? minutesElement.textContent : "00";
      const seconds = secondsElement ? secondsElement.textContent : "00";
      const duration = `${minutes}:${seconds}`;
      const intervalData = {
        id: currentIntervalId,
        name: name,
        duration: duration,
        type: type
      };

      // Nachricht an Timer-Editor senden
      if (window.opener) {
        window.opener.postMessage({ type: 'saveInterval', data: intervalData }, window.location.origin);
      } else {
        console.warn("No opener window found. Interval data not sent.");
      }

      window.location.href = '../timer-editor/timer-editor.html';
    });

    // --- Initialisierung beim Laden ---
    document.addEventListener('DOMContentLoaded', () => {
      wheels.forEach((wheel) => {
        updateWheel(wheel);
      });

      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'loadInterval') {
          const intervalToLoad = event.data.data;
          currentIntervalId = intervalToLoad.id;
          intervalNameInput.value = intervalToLoad.name;

          if (intervalToLoad.type === 'rest') {
            tabRest.click();
          } else {
            tabInterval.click();
          }

          const [initialMinutes, initialSeconds] = intervalToLoad.duration.split(':');
          if (intervalToLoad.type === 'interval') {
            setWheelValue('minutes-wheel', initialMinutes);
            setWheelValue('seconds-wheel', initialSeconds);
          } else {
            setWheelValue('minutes-wheel-rest', initialMinutes);
            setWheelValue('seconds-wheel-rest', initialSeconds);
          }
        }
      });

      if (!window.opener) {
        setWheelValue('minutes-wheel', '00');
        setWheelValue('seconds-wheel', '00');
        intervalNameInput.value = 'Intervall';
        tabInterval.click();
      }
    });
  </script>
</body>
</html>